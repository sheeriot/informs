{% extends "base.html" %}

{% load static %}
{% load custom_tags %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <!-- Field Op Header -->
    <div class="d-flex align-items-center mb-3">
        <div class="d-flex align-items-center">
            <h2 class="mb-0 me-2">Aid Requests List</h2>
            <a class="btn btn-info" href="{% url 'field_op_detail' slug=field_op.slug %}">
                <i class="bi bi-truck"></i>
                {{ field_op.name }}
            </a>
        </div>
    </div>

    <!-- Include Field Op Key Data from partial -->
    {% include "aidrequests/partials/aid_request_list_header.html" %}

    <!-- Aid Requests Filter section -->
    {% include "aidrequests/includes/aid_requests_filter.html" %}

    <!-- Aid Requests Map and List sections -->
    <div class="row">
        <!-- Aid Requests Map Section -->
        {% include "aidrequests/includes/aid_requests_map.html" %}

        <!-- Aid Requests List/Table -->
        {% include "aidrequests/includes/aid_requests_table.html" %}
    </div>

</div>

<!-- Data Section -->
<div class="d-none">
    <!-- Aid requests data - Combined format for both map and list -->
    <script id="aid-locations-data" type="application/json">
        {{ aid_requests_json|safe }}
    </script>

    <!-- Initial filter state -->
    <script id="filter-state-initial" type="application/json">
        {{ initial_filter_state|safe }}
    </script>

    <!-- Filter data -->
    {% if aid_types_json %}
        <script id="aid-types-json" type="application/json">{{ aid_types_json|safe }}</script>
    {% endif %}
    {{ status_choices_json|default:'[]'|json_script:'status-choices-data' }}
    {{ priority_choices_json|default:'[]'|json_script:'priority-choices-data' }}
</div>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
{% endblock %}

{% block extra_css %}
<!-- Azure Maps CSS -->
<link href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" rel="stylesheet" />
<link href="{% static 'css/azure-maps-layer-legend.css' %}" rel="stylesheet" />

<!-- Fix for table dropdowns visibility -->
<style>
    /* Fix for dropdowns that overflow the table container */
    #aid-request-list-table-container {
        overflow: visible !important;
    }

    /* Alternative solution for mobile/smaller screens */
    @media (max-width: 992px) {
        .dropdown-fix-overflow .dropdown-menu {
            position: fixed !important;
            max-height: 300px;
            overflow-y: auto;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Azure Maps JavaScript -->
<script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>
<!-- Azure Maps Layer Legend -->
<script src="{% static 'js/azure-maps-layer-legend.js' %}?v={{static_version}}"></script>
<!-- Application JavaScript -->
<script src="{% static 'js/aidrequests-filter.js' %}?v={{static_version}}"></script>
<script src="{% static 'js/aidrequests-list.js' %}?v={{static_version}}"></script>
<script src="{% static 'js/map_aidrequests.js' %}?v={{static_version}}"></script>
<script src="{% static 'js/aidrequests-ajax.js' %}?v={{static_version}}"></script>
<script src="{% static 'js/tak-alert.js' %}?v={{static_version}}"></script>

<script>
    function copyCoordinates() {
        const coordInput = document.getElementById('coordinates');
        coordInput.select();
        coordInput.setSelectionRange(0, 99999); // For mobile devices
        navigator.clipboard.writeText(coordInput.value).then(() => {
            const btn = event.currentTarget;
            const icon = btn.querySelector('i');
            icon.classList.remove('bi-clipboard');
            icon.classList.add('bi-clipboard-check');
            setTimeout(() => {
                icon.classList.remove('bi-clipboard-check');
                icon.classList.add('bi-clipboard');
            }, 2000);
        });
    }
</script>
{% endblock %}
