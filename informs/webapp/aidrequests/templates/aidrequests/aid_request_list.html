{% extends "base.html" %}

{% load static %}
{% load custom_tags %}

{% block content %}

<div class="container m-4">
    <h2 class="mb-3">Aid Requests: {{ field_op.name }}
        <a href="{% url 'field_op_detail' pk=field_op.pk %}" class="btn btn-outline-info btn-sm me-2">
            <i class="bi bi-truck text-primary"></i>
        </a>
    </h2>

    <!-- Summary cards -->
    <div class="row mb-3">
        <!-- Aid Types Summary Card -->
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Aid Types</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        {% for aid_type, data in aid_type_counts.items %}
                            <span class="summary-item badge rounded-pill bg-primary fs-6 py-2 px-3 mb-2"
                                  data-filter-type="aid_type"
                                  data-filter-value="{{ data.value }}">
                                {{ aid_type }}: <strong>{{ data.count }}</strong>
                            </span>
                        {% empty %}
                            <p class="text-muted">No aid requests found.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Summary Card -->
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Status</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        {% for status, data in status_counts.items %}
                            <span class="summary-item badge rounded-pill bg-info fs-6 py-2 px-3 mb-2"
                                  data-filter-type="status"
                                  data-filter-value="{{ data.value }}">
                                {{ status }}: <strong>{{ data.count }}</strong>
                            </span>
                        {% empty %}
                            <p class="text-muted">No aid requests found.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Priority Summary Card -->
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">Priority</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        {% for priority, data in priority_counts.items %}
                            <span class="summary-item badge rounded-pill bg-warning text-dark fs-6 py-2 px-3 mb-2"
                                  data-filter-type="priority"
                                  data-filter-value="{{ data.value }}">
                                {{ priority }}: <strong>{{ data.count }}</strong>
                            </span>
                        {% empty %}
                            <p class="text-muted">No aid requests found.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- List.js container -->
    <div id="aidrequest-list-container">
        <!-- Filter section -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Filters</h5>
                            <span id="results-counter" class="badge bg-light text-dark">
                                {{ filtered_aid_requests|length }} results
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Search input -->
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" id="aid-request-search" class="search form-control" placeholder="Search aid requests...">
                                </div>
                            </div>

                            <!-- Aid Type Filter -->
                            <div class="col-md-2">
                                <select id="aid-type-filter" class="form-select">
                                    <option value="">All Aid Types</option>
                                    {% for aid_type in aid_types_list %}
                                        <option value="{{ aid_type.slug }}">{{ aid_type.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Status Group Filter -->
                            <div class="col-md-2">
                                <select id="status-filter" class="form-select">
                                    <option value="active" selected>Active Status</option>
                                    <option value="inactive">Inactive Status</option>
                                    <option value="">All Statuses</option>
                                    {% for status_code, status_name in status_choices_list %}
                                        <option value="{{ status_code }}">{{ status_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Priority Filter -->
                            <div class="col-md-2">
                                <select id="priority-filter" class="form-select">
                                    <option value="">All Priorities</option>
                                    {% for priority_code, priority_name in priority_choices_list %}
                                        <option value="{{ priority_code }}">{{ priority_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aid Requests Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="card-title mb-0">Aid Requests</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table id="aidrequest-table" class="table table-striped table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th data-sort="aid-request-id">ID</th>
                                        <th data-sort="aid-type-name">Type</th>
                                        <th data-sort="address">Address</th>
                                        <th data-sort="city">City</th>
                                        <th data-sort="zip-code">ZIP</th>
                                        <th data-sort="status-display">Status</th>
                                        <th data-sort="priority-display">Priority</th>
                                        <th data-sort="created-at">Created</th>
                                        <th data-sort="updated-at">Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="list">
                                    <!-- List.js will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between mt-3">
        <div class="me-2">
            <a href="{% url 'aid_request_create' field_op=field_op.slug %}">
                <button class="btn btn-success p-1">
                    <i class="bi bi-plus-circle"></i>
                    Add
                </button>
            </a>
        </div>
        <div class="d-flex-inline">
            <button id="tak-alert-button" class="btn btn-danger btn-sm mx-1 p-1">
                <i class="bi bi-bullseye"></i> Alert TAK
            </button>
            <button id="tak-clear-button" class="btn btn-success btn-sm mx-1 p-1">
                <i class="bi bi-bullseye"></i> Clear TAK
            </button>
            <button id="tak-test-button" class="btn btn-info btn-sm mx-1 p-1">
                <i class="bi bi-bullseye"></i> Test Button
            </button>
            <div class="d-inline-flex align-items-left mx-1 p-0 text-dark font-monospace">
                <div id="send-cot-status"></div>
            </div>
        </div>
        <div class="d-flex justify-content-end">
            <a href="{% url 'aid_requests_csv' field_op=field_op.slug %}">
                <button class="btn btn-info p-1">
                    <i class="bi bi-download"></i>
                    Export
                </button>
            </a>
        </div>
    </div>

    <hr class="m-1">

    <h2>Aid Request Map</h2>
    <div id="map2Container" style="position:relative;width:100%;min-width:290px;height:800px;"></div>

</div>

<!-- Pass data to JavaScript -->
{{ aid_types|json_script:'aid-types-map-data' }}
{{ aid_locations|json_script:'aid-locations-data' }}
{% if aid_requests_json %}
    {{ aid_requests_json|json_script:'aid-requests-data' }}
{% else %}
    <script id="aid-requests-data" type="application/json">[]</script>
{% endif %}
{% if aid_types_json %}
    {{ aid_types_json|json_script:'aid-types-json' }}
{% else %}
    <script id="aid-types-json" type="application/json">{}</script>
{% endif %}
{{ status_choices_json|default:'[]'|json_script:'status-choices-data' }}
{{ priority_choices_json|default:'[]'|json_script:'priority-choices-data' }}
<span id="field-op-name" class="d-none">{{ field_op.name }}</span>
<span id="field-op-slug" class="d-none">{{ field_op.slug }}</span>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}

<!-- Hidden debug info -->
<div id="debug-info" style="display: none;">
    <h4>Debug Information</h4>
    <p>Aid Types:</p>
    <pre>{{ aid_type_counts|pprint }}</pre>
    <p>Status Values:</p>
    <pre>{{ status_counts|pprint }}</pre>
    <p>Priority Values:</p>
    <pre>{{ priority_counts|pprint }}</pre>
</div>

{% endblock %}

{% block extra_css %}
<link href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" rel="stylesheet" />
<link href="{% static 'css/azure-maps-layer-legend.css' %}" rel="stylesheet" />
<link href="{% static 'css/aid_request_list.css' %}?v={{static_version}}" rel="stylesheet" />
{% endblock %}

{% block extra_js %}
<script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>
<script src="{% static 'js/azure-maps-layer-legend.js' %}?v={{static_version}}"></script>
<script src="{% static 'js/map_aidrequests.js' %}?v={{static_version}}"></script>
<script src="{% static 'js/list-aid-requests.js' %}?v={{static_version}}"></script>
<script src="{% static 'js/map-visibility-handler.js' %}?v={{static_version}}"></script>

<!-- Map configuration data -->
<meta id="fieldop-lat" content="{{ field_op.latitude|stringformat:".6f"|default:"0" }}">
<meta id="fieldop-lon" content="{{ field_op.longitude|stringformat:".6f"|default:"0" }}">
<meta id="azure-maps-key" content="{{ azure_maps_key }}">
<meta id="map-zoom" content="{{ field_op.map_zoom|default:"8" }}">
<meta id="center-lat" content="{{ field_op.latitude|stringformat:".6f"|default:"0" }}">
<meta id="center-lon" content="{{ field_op.longitude|stringformat:".6f"|default:"0" }}">
<meta id="ring-size" content="{{ field_op.ring_km|default:"5" }}">
{% endblock %}
