{% extends "base.html" %}

{% load static %}

{% block content %}
<div class="container m-4">
    <div class="row flex-row align-items-center my-1">
        <div class="col-auto display-4 font-monospace">
            Field Op Details
        </div>
        <div class="col-auto font-monospace bg-light ms-4 p-0" style="font-size: 0.75rem;">
            <table class="table border border-1 m-0 p-0">
                <tr>
                    <td class="border border-info bg-transparent m-0 px-1 py-0">
                        created:
                        {{ object.created_at|date:"Y-m-d H:i" }}
                        ({{ object.created_by }})
                    </td>
                </tr>
                <tr>
                    <td class="border border-info bg-transparent m-0 px-1 py-0">
                        updated:
                        {{ object.updated_at|date:"Y-m-d H:i" }}
                        ({{ object.updated_by }})
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <hr class="m-0 mb-3" />

    <!-- Actions Card -->
    <div class="mx-auto" style="max-width: 800px;">
        <div class="fieldset-box p-3 border rounded mb-3">
            <h5>Actions</h5>
            <div class="d-flex gap-2">
                <a href="{% url 'field_op_update' slug=object.slug %}" class="btn btn-warning">
                    <i class="bi bi-pencil"></i> Edit Field Op
                </a>
                <a href="{% url 'field_op_list' %}" class="btn btn-outline-info text-dark">
                    <i class="bi bi-truck"></i> Field Op List
                </a>
                <a href="{% url 'aid_request_list' field_op=object.slug %}" class="btn btn-outline-success text-dark">
                    <i class="bi bi-life-preserver text-danger"></i> Aid Request List
                    <span class="badge bg-success">{{ aid_request_count }}</span>
                </a>
            </div>
        </div>

        <!-- Basic Information -->
        <div class="fieldset-box p-3 border rounded mb-3">
            <h5>Basic Information</h5>
            <div class="row g-0 mb-2">
                <div class="col-md-6 p-1">
                    <strong>Name:</strong>
                    <div class="fs-4 text-danger">{{ object.name }}</div>
                </div>
                <div class="col-md-6 p-1">
                    <strong>Slug:</strong>
                    <div class="fs-4 text-dark">{{ object.slug }}</div>
                </div>
            </div>
        </div>

        <!-- Location Details -->
        <div class="fieldset-box p-3 border rounded mb-3">
            <h5>Location Details</h5>
            <div class="row g-0 mb-2">
                <div class="col-md-10 p-1">
                    <strong>Map Coordinates:</strong>
                    <div class="input-group" style="max-width: 300px;">
                        <input type="text" class="form-control fs-5 text-dark font-monospace" id="coordinates"
                               value="{{ object.latitude }},{{ object.longitude }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyCoordinates()">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-2 p-1">
                    <strong>Ring Size:</strong>
                    <div class="fs-4 text-dark">
                        {% if object.ring_size %}
                            {{ object.ring_size }} km
                        {% else %}
                            <span class="text-muted">Not set</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div class="fieldset-box p-3 border rounded mb-3">
            <h5>Settings</h5>
            <div class="row g-0 mb-2">
                <div class="col-md-8 p-1">
                    <strong>TAK Server:</strong>
                    <div class="fs-4 text-dark">
                        {% if object.tak_server %}
                            {{ object.tak_server }}
                        {% else %}
                            <span class="text-muted">Not set</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4 p-1">
                    <strong>COT Status:</strong>
                    <div class="fs-4">
                        {% if object.disable_cot %}
                            <span class="text-danger">
                                <i class="bi bi-x-circle"></i> Disabled
                            </span>
                        {% else %}
                            <span class="text-success">
                                <i class="bi bi-check-circle"></i> Enabled
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Notify Destinations -->
        <div class="fieldset-box p-3 border rounded mb-3">
            <h5>Notify Destinations</h5>
            <table class="table table-border table-success font-monospace border border-1 m-0 p-0 w-auto">
                <caption>Note: sms not yet implemented</caption>
                <thead>
                    <tr>
                        <th class="col-auto border border-success">Name</th>
                        <th class="col-auto border border-success">Type</th>
                        <th class="col-auto border border-success">Address</th>
                    </tr>
                </thead>
                <tbody>
                    {% for notify in notifies_email %}
                        <tr class="text-primary">
                            <td class="col-auto border border-success">{{ notify.name }}</td>
                            <td class="col-auto border border-success">{{ notify.type }}</td>
                            <td class="col-auto border border-success">{{ notify.email|default_if_none:"" }}</td>
                        </tr>
                    {% endfor %}
                    {% for notify in notifies_sms %}
                        <tr class="text-muted" style="font-size: 0.75rem;">
                            <td class="col-auto border bg-light text-muted">{{ notify.name }}</td>
                            <td class="col-auto border bg-light text-muted">{{ notify.type }}</td>
                            <td class="col-auto border bg-light text-muted">{{ notify.sms_number|default_if_none:"" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Static Map Preview -->
        {% if static_map_url %}
        <div class="fieldset-box p-3 border rounded mb-3">
            <h5>Location Preview</h5>
            <img src="data:image/png;base64,{{ static_map_url }}"
                 alt="Field Op Location"
                 class="img-fluid border rounded"
                 style="max-width: 600px;">
        </div>
        {% endif %}
    </div>

    <hr class="m-1">
    <link href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" rel="stylesheet" />
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>
    <script type="text/javascript" src="{% static 'js/map_aidrequests.js' %}?v6"></script>

    {{ aid_locations|json_script:'aid-locations-data' }}

    <script>
        function copyCoordinates() {
            const coordInput = document.getElementById('coordinates');
            coordInput.select();
            coordInput.setSelectionRange(0, 99999); // For mobile devices
            navigator.clipboard.writeText(coordInput.value).then(() => {
                const btn = event.currentTarget;
                const icon = btn.querySelector('i');
                icon.classList.remove('bi-clipboard');
                icon.classList.add('bi-clipboard-check');
                setTimeout(() => {
                    icon.classList.remove('bi-clipboard-check');
                    icon.classList.add('bi-clipboard');
                }, 2000);
            });
        }

        const locations_data = JSON.parse(document.getElementById('aid-locations-data').textContent)
        const mapContext = {
            fieldop_lat: "{{ object.latitude|safe }}",
            fieldop_lon: "{{ object.longitude|safe }}",
            apiKey: "{{ azure_maps_key|escapejs }}",
            aid_locations: locations_data,
            map_zoom: "{{ map_zoom|safe  }}",
            center_lat: "{{ center_lat|safe }}",
            center_lon: "{{ center_lon|safe }}"
        }
        document.addEventListener("DOMContentLoaded", function() {
            initMap(mapContext);
        })
    </script>
    <fieldset style="width:calc(100% - 30px);min-width:290px;margin-top:10px;">
        <legend>Field Operation Map: {{ object.name }}</legend>
    </fieldset>
    <div id="mapContainer" style="position:relative;width:100%;min-width:290px;height:800px;"></div>
</div>
{% endblock %}
