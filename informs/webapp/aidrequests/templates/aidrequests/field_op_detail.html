{% extends "base.html" %}
{% load bootstrap_icons %}
{% load static %}
{% load crispy_forms_tags %}
{% load custom_tags %}

{% block page_title %}{{ object.name }} - Field Op{% endblock %}

{% block extra_css %}
<style>
    .coordinates-input-group {
        max-width: 300px; /* Or adjust as needed */
    }
</style>
<link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" type="text/css" />
{% endblock %}


{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Details Column -->
        <div class="col-lg-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">{{ object.name }}</h2>
                <div>
                    <a href="{% url 'aid_request_list' field_op=object.slug %}" class="btn btn-outline-info text-dark">
                        <i class="bi bi-life-preserver text-danger"></i> View Aid Requests
                        <span class="badge bg-info text-dark ms-1">{{ object.aid_requests.count }}</span>
                    </a>
                    <a href="{% url 'field_op_update' slug=object.slug %}" class="btn btn-warning ms-2">
                        {% bs_icon 'pencil-square' %} Edit
                    </a>
                    <a href="{% url 'field_op_list' %}" class="btn btn-secondary ms-2">
                        All Field Ops
                    </a>
                </div>
            </div>

            {% include 'aidrequests/includes/field_op_summary.html' %}

            <!-- Map -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Field Operation Map</h5>
                </div>
                <div class="card-body p-0">
                    <div id="aid-request-map"
                         class="map-container-full-width"
                         data-azure-maps-key="{{ azure_maps_key }}"
                         data-field-op-name="{{ field_op_name }}"
                         data-field-op-slug="{{ field_op_slug }}"
                         data-center-lat="{{ center_lat|stringformat:'f'|default:0 }}"
                         data-center-lon="{{ center_lon|stringformat:'f'|default:0 }}"
                         data-ring-size="{{ ring_size|default:10 }}"
                         data-bounds-west="{{ map_bounds.0 }}"
                         data-bounds-south="{{ map_bounds.1 }}"
                         data-bounds-east="{{ map_bounds.2 }}"
                         data-bounds-north="{{ map_bounds.3 }}">
                    </div>
                </div>
                <div class="card-footer" id="map-filter-summary-card" >
                    <div id="map-filter-summary" class="small text-muted">Loading map...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data scripts -->
<script type="application/json" id="aid-locations-data">
    {{ aid_locations_json|safe }}
</script>
<script type="application/json" id="aid-types-json">
    {{ aid_types_json|safe }}
</script>
<script type="application/json" id="filter-state-initial">
    {
        "aid_types": "all",
        "statuses": "all",
        "priorities": "all"
    }
</script>

{% endblock %}

{% block extra_js %}
<!-- Application JavaScript -->
<script src="{% static 'js/utils-copy-coordinates.js' %}?v={{STATIC_VERSION}}"></script>
<script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>
<script src="{% static 'js/map_aidrequests.js' %}"></script>
{% endblock %}
