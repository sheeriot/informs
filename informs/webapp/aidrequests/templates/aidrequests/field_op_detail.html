{% extends "base.html" %}
{% load bootstrap_icons %}
{% load static %}
{% load crispy_forms_tags %}
{% load custom_tags %}

{% block page_title %}{{ object.name }} - Field Op{% endblock %}

{% block extra_css %}
<style>
    .coordinates-input-group {
        max-width: 300px; /* Or adjust as needed */
    }
</style>
<link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" type="text/css" />
{% endblock %}


{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Details Column -->
        <div class="col-lg-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">{{ object.name }}</h2>
                <div>
                    <a href="{% url 'aid_request_list' field_op=object.slug %}" class="btn btn-outline-info text-dark">
                        <i class="bi bi-life-preserver text-danger"></i> View Aid Requests
                        <span class="badge bg-info text-dark ms-1">{{ object.aid_requests.count }}</span>
                    </a>
                    <a href="{% url 'field_op_update' slug=object.slug %}" class="btn btn-warning ms-2">
                        {% bs_icon 'pencil-square' %} Edit
                    </a>
                    <a href="{% url 'field_op_list' %}" class="btn btn-secondary ms-2">
                        All Field Ops
                    </a>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0 align-items-center">
                        <dt class="col-sm-2"><i class="bi bi-card-heading text-dark me-2"></i>Name</dt>
                        <dd class="col-sm-4">{{ object.name }}</dd>

                        <dt class="col-sm-2"><i class="bi bi-tag text-dark me-2"></i>Slug</dt>
                        <dd class="col-sm-4">{{ object.slug }}</dd>

                        <dt class="col-sm-2"><i class="bi bi-geo-alt text-success me-2"></i>Coordinates</dt>
                        <dd class="col-sm-4">
                            <span class="input-group input-group-sm">
                                <input type="text" class="form-control form-control-sm" id="coordinates" value="{{ object.latitude|floatformat:5 }}, {{ object.longitude|floatformat:5 }}" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="copyCoordinates(event)" title="Copy to clipboard">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </span>
                        </dd>

                        <dt class="col-sm-2"><i class="bi bi-circle text-primary me-2"></i>Ring Size</dt>
                        <dd class="col-sm-4">{{ object.ring_size }} km</dd>

                        <dt class="col-sm-2">
                            <i class="bi bi-hdd-rack" style="color: var(--bs-purple);"></i><i class="bi bi-plus-circle me-2" style="color: var(--bs-purple);"></i>TAK Server
                        </dt>
                        <dd class="col-sm-4">{{ object.tak_server.name|default:"Not set" }}</dd>

                        <dt class="col-sm-2">
                            <i class="bi bi-power {% if object.disable_cot %}text-secondary{% else %}text-success{% endif %} me-2"></i>COT Status
                        </dt>
                        <dd class="col-sm-4">
                           {% if object.disable_cot %}
                               <span class="text-secondary">Disabled</span>
                           {% else %}
                               <span class="text-success">Enabled</span>
                           {% endif %}
                        </dd>

                        <dt class="col-sm-2"><i class="bi bi-life-preserver text-danger me-2"></i>Aid Types</dt>
                        <dd class="col-sm-10">
                            {% for type in object.aid_types.all %}
                                {{ type.name }}{% if not forloop.last %}, {% endif %}
                            {% empty %}
                                <span class="text-muted">No aid types specified.</span>
                            {% endfor %}
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- Map -->
            <div class="card" style="height: 100%;">
                <div class="card-header">
                    <h5 class="card-title mb-0">Field Operation Map</h5>
                </div>
                <div class="card-body p-0">
                    <div id="aid-request-map"
                         style="height: 600px; width: 100%;"
                         data-azure-maps-key="{{ azure_maps_key }}"
                         data-field-op-name="{{ field_op_name }}"
                         data-field-op-slug="{{ field_op_slug }}"
                         data-center-lat="{{ center_lat|stringformat:'f'|default:0 }}"
                         data-center-lon="{{ center_lon|stringformat:'f'|default:0 }}"
                         data-ring-size="{{ ring_size|default:10 }}"
                         data-bounds-west="{{ map_bounds.0 }}"
                         data-bounds-south="{{ map_bounds.1 }}"
                         data-bounds-east="{{ map_bounds.2 }}"
                         data-bounds-north="{{ map_bounds.3 }}">
                    </div>
                </div>
                <div class="card-footer" id="map-filter-summary-card" >
                    <div id="map-filter-summary" class="small text-muted">Loading map...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data scripts -->
<script type="application/json" id="aid-locations-data">
    {{ aid_locations_json|safe }}
</script>
<script type="application/json" id="aid-types-json">
    {{ aid_types_json|safe }}
</script>
<script type="application/json" id="filter-state-initial">
    {
        "aid_types": "all",
        "statuses": "all",
        "priorities": "all"
    }
</script>

{% endblock %}

{% block extra_js %}
<!-- Application JavaScript -->
<script src="{% static 'js/utils-copy-coordinates.js' %}?v={{STATIC_VERSION}}"></script>
<script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>
<script src="{% static 'js/map_aidrequests.js' %}"></script>
{% endblock %}
