{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load bootstrap_icons %}
{% load static %}

{% block content %}
<div class="container m-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        {% if form.action == "create" %}
            <div class='form-header'>
                <h2>Field Op</h2>
            </div>
        {% else %}
            <div class="form-header">
                <h2>Update Field Op</h2>
            </div>
        {% endif %}
    </div>

    <div>Each "Field Op" is a distinct call to support (response) for a region.</div>
    <span>
        <em>
        This form should be used to create and update Field Ops.<br>
        Note, some settings (TAK Server, Notifies) are set in the /admin pages.
        </em>
    </span>
    <hr>
    <p>
        Each "Field Op" will get a unique short name (aka slug), i.e.
        <strong>
        <ul>
            <li>nc2024: North Carolina - 2024 - Hurricane Helene</li>
            <li>milton2024: Hurricane Milton - Florida 2024</li>
        </ul>
        </strong>
    </p>
    <form method="post" novalidate>
        {% csrf_token %}
        {% crispy form %}
    </form>
</div>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" type="text/css" />
{% endblock %}

{% block extra_js %}
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>
    <script src="{% static 'js/fieldop-form-map.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const azureMapsKey = "{{ azure_maps_key|default:'' }}";
            const mapDiv = document.getElementById('location-picker-map');

            if (azureMapsKey && mapDiv) {
                const initialLat = mapDiv.dataset.initialLat ? parseFloat(mapDiv.dataset.initialLat) : null;
                const initialLon = mapDiv.dataset.initialLon ? parseFloat(mapDiv.dataset.initialLon) : null;

                initLocationPickerMap('location-picker-map', azureMapsKey, initialLat, initialLon);
            } else if (!azureMapsKey) {
                console.warn("Azure Maps key not provided. The location picker map will not be initialized.");
                if(mapDiv) {
                    mapDiv.innerHTML = '<div class="alert alert-warning m-0">Map is not available. Please configure Azure Maps key.</div>';
                }
            }
        });
    </script>
{% endblock %}
